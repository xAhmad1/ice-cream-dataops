name: Deploy Toolkit
on:
  push:
    branches:
      - main
    paths:
      - ice-cream-dataops/**  # Make sure this matches default_organization_dir in cdf.toml
  workflow_dispatch:
    inputs:
      environment:
        description: Pick one
        required: false
        type: choice
        options:
          - test
          - prod

jobs:
  build-modules:
    name: Build & Deploy
    runs-on: ubuntu-latest
    container:
      image: cognite/toolkit:0.6.53  # Make sure the toolkit version matches the version in cdf.toml
    strategy:
      matrix:
        include:
          # Deploy to 'test' environment automatically, only on push to main branch
          - environment: ${{ inputs.environment != '' && inputs.environment || 'test' }}

    environment: ${{ matrix.environment }}
    env:
      # Cognite Toolkit environment variables
      CDF_PROJECT: cdf-bootcamp-37-${{ matrix.environment }}
      CDF_CLUSTER: westeurope-1

      LOGIN_FLOW: client_credentials
      IDP_TENANT_ID: ${{ secrets.IDP_TENANT_ID }}
      IDP_TOKEN_URL: https://login.microsoftonline.com/${{ secrets.IDP_TENANT_ID }}/oauth2/v2.0/token

      IDP_CLIENT_ID: ${{ secrets.IDP_CLIENT_ID }}
      IDP_CLIENT_SECRET: ${{ secrets.IDP_CLIENT_SECRET }}

      DATA_DEVELOPER_SOURCE_ID: ${{ secrets.DATA_DEVELOPER_SOURCE_ID }}

      DATA_PIPELINE_OEE_CLIENT_ID: ${{ secrets.DATA_PIPELINE_OEE_CLIENT_ID }}
      DATA_PIPELINE_OEE_CLIENT_SECRET: ${{ secrets.DATA_PIPELINE_OEE_CLIENT_SECRET }}
      DATA_PIPELINE_OEE_SOURCE_ID: ${{ secrets.DATA_PIPELINE_OEE_SOURCE_ID }}

      ICAPI_EXTRACTORS_CLIENT_ID: ${{ secrets.ICAPI_EXTRACTORS_CLIENT_ID }}
      ICAPI_EXTRACTORS_CLIENT_SECRET: ${{ secrets.ICAPI_EXTRACTORS_CLIENT_SECRET }}
      ICAPI_EXTRACTORS_SOURCE_ID: ${{ secrets.ICAPI_EXTRACTORS_SOURCE_ID }}

    steps:
      - uses: actions/checkout@v4

      - name: Debug Auth Variables
        run: |
          echo "------ DEBUG AUTH ENV ------"
          echo "IDP_CLIENT_ID: $IDP_CLIENT_ID"
          echo "IDP_TENANT_ID: $IDP_TENANT_ID"
          echo "IDP_TOKEN_URL: $IDP_TOKEN_URL"
          echo "LOGIN_FLOW: $LOGIN_FLOW"
          echo "CDF_PROJECT: $CDF_PROJECT"
          echo "SECRET LENGTHS:"
          echo "  IDP_CLIENT_SECRET: ${#IDP_CLIENT_SECRET}"
          echo "  DATA_PIPELINE_OEE_CLIENT_SECRET: ${#DATA_PIPELINE_OEE_CLIENT_SECRET}"
          echo "  ICAPI_EXTRACTORS_CLIENT_SECRET: ${#ICAPI_EXTRACTORS_CLIENT_SECRET}"

      - name: Inspect Token (debug)
        env:
          CDF_LOG_LEVEL: debug
        run: |
          echo "------ INSPECT TOKEN ------"
          cdf auth verify
          cdf auth inspect-token || true

      - name: Build Toolkit Configurations
        run: cdf build --env=${{ matrix.environment }}

      - name: Deploy Toolkit Configurations
        env:
          CDF_LOG_LEVEL: debug
        run: |
          echo "------ DEPLOY START ------"
          cdf deploy --env=${{ matrix.environment }}
